  @Test
  public void should_swallow_log_and_report_checks_exceptions() {
    JavaAstScanner scanner = defaultJavaAstScanner();
    SonarComponents sonarComponent = new SonarComponents(null, context.fileSystem(), null, null, null, null);
    sonarComponent.setSensorContext(context);
    scanner.setVisitorBridge(new VisitorsBridge(Collections.singleton(new CheckThrowingException(new NullPointerException("foo"))), new ArrayList<>(), sonarComponent));
    File scannedFile = new File("src/test/resources/AstScannerNoParseError.txt");

    scanner.scan(ImmutableList.of(scannedFile));
    assertThat(logTester.logs(LoggerLevel.ERROR)).hasSize(1).contains("Unable to run check class org.sonar.java.ast.JavaAstScannerTest$CheckThrowingException -  on file "
      + scannedFile.getPath()
      + ", To help improve SonarJava, please report this problem to SonarSource : see https://www.sonarqube.org/community/");
    assertThat(sonarComponent.analysisErrors).hasSize(1);
    assertThat(sonarComponent.analysisErrors.get(0).getKind()).isSameAs(AnalysisError.Kind.CHECK_ERROR);
    logTester.clear();
    scanner.setVisitorBridge(new VisitorsBridge(new AnnotatedCheck(new NullPointerException("foo"))));
    scannedFile = new File("src/test/resources/AstScannerParseError.txt");
    scanner.scan(ImmutableList.of(scannedFile));
    assertThat(logTester.logs(LoggerLevel.ERROR)).hasSize(3).contains("Unable to run check class org.sonar.java.ast.JavaAstScannerTest$AnnotatedCheck - AnnotatedCheck on file "
      + scannedFile.getPath()
      + ", To help improve SonarJava, please report this problem to SonarSource : see https://www.sonarqube.org/community/");
  }

